{% extends "base.html" %}

{% block content %}
<div class="plot-container">
    <div id="attendance-plot"></div>
    <form action="/survey/{{ qid_n }}" method="POST">
        <input type="hidden" id="clicked-data" name="clicked_data">
        <button type="submit" class="btn btn-primary">Next Question</button>
    </form>
</div>

<script>
    function initializePlot() {
    try {
        {% if plot_json %}
            var graphs = {{ plot_json | safe }};
            var myPlot = document.getElementById('attendance-plot');
            
            Plotly.newPlot('attendance-plot', graphs.data, graphs.layout)
                .then(function() {
                    myPlot.on('plotly_click', function(data) {
                        var pt = data.points[0];

                        document.getElementById('clicked-data').value = JSON.stringify({
                            school: pt.y,
                            month: pt.x,
                            absences: Math.round(pt.z)
                        });
                        
                        
                        // Create selection outline
                        var update = {
                            'shapes': [{
                                type: 'rect',
                                xref: 'x',
                                yref: 'y',
                                x0: pt.x,
                                y0: pt.y,
                                x1: pt.x,
                                y1: pt.y,
                                line: {
                                    color: 'red',
                                    width: 3
                                }
                            }]
                        };
                        
                        Plotly.relayout('attendance-plot', update);
                    });
                });
        {% else %}
            document.getElementById('attendance-plot').innerHTML = 
                '<p class="error">No attendance data available.</p>';
        {% endif %}
    } catch (error) {
        console.error("Error initializing plot:", error);
        document.getElementById('attendance-plot').innerHTML = 
            '<p class="error">Error initializing plot: ' + error.message + '</p>';
    }
}

// Initialize plot when Plotly is ready
if (typeof Plotly !== 'undefined') {
    initializePlot();
} else {
    document.addEventListener('DOMContentLoaded', function() {
        initializePlot();
    });
}
</script>
{% endblock %}